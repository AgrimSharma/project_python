{% extends "base.html" %}

	{% block content %}
 <script type="text/javascript">
function MM_openBrWindow(theURL,winName,features) { //v2.0
  window.open(theURL,winName,features);
}


    </script>

<div id="wrap">
{% load sorting_tags %}
{% autosort bags %}
  
  <div class="container-fluid main" role="main" id="main">
  <div class="row-fluid">
    <div class="span12">
        {% include "hub/nav.html" %}
    </div>
  </div>
    
    <div class="row-fluid">
      <div class="span12">
        <div class="survey-details">
          <div class="cust-title">
            <i class="icon-truck" style="font-size: 28px ; margin-right: 10px;margin-top: 2px;"></i> <span>Bag Tally </span>
            <div style="display:inline-block"><form><input style=" width:100px" type="text" size="9" placeholder="Inscan bag" class="inscan_bag" id="bag_scan" name="inscan_bag"/></form></div>
            <div style="display:inline-block"><form>Count:<input id="verified_count" style=" width:20px" type="text" size="9"  value="{{sucess_bags.count}}"/></form></div>
            <div style="display:inline-block"><form>Mismatch count:<input id="mismatch_count" style="width:20px" type="text" size="9" value="{{mismatch_bags.count}}"/></form></div>
            </div>
            
          <div class="cust-content">
          	<div class="content-login">
            <h3>Welcome {{request.user.employeemaster.firstname}}</h3><br/>
            <table class="table">
            	<tr>
                  <td><b>ORG</b></td><td><input type="text" id="origin" style="width:50px; height:30px"/></td>
                    <td><b>Run Date</b></td><td><input type="text" id="date" style="width:70px; height:30px"/></td>
                	<td><b>Run Code</b></td><td><input type="text" id="run_code" style="width:50px; height:30px"/></td>
                    <td><b>Vehicle/Flight No.</b></td><td><input id="flight_num" type="text" style="width:60px; height:30px"/></td>
                </tr>
                <tr>
                	<td><b>CoLoader Name</b></td><td><input id="coloader_name"type="text" style="width:108px; height:30px"/></td>
                	<td><b>ATA</b></td><td><input type="text" id="atd" style="width:37px; height:30px"/></td>
                	
                	<td><b>DEST</b></td><td><input type="text"  style="width:50px; height:30px" id="destination"/></td>
                
                
                	<td><b>Weight</b></td><td><input type="text" id="actual_weight" style="width:56px; height:30px"/></td>
                </tr>
            </table>
            <table>
            	<tr>
<td><button class="btn btn-primary" href="#" title="View shipments" onClick="MM_openBrWindow('/hub/bag_tallied/','shipment','scrollbars=yes,width=400,height=300')">All Bag Tallied</button></td>
<td><button class="btn btn-primary" href="#" title="View shipments" onClick="MM_openBrWindow('/hub/connection_tallied/','shipment','scrollbars=yes,width=400,height=300')">Connection Tallied</button>
                </tr>
            </table>
            </div>
        
       <!---div class="container-fluid connection-data"style='padding-top:5px;dispaly:flex;'><div style="width:90%; padding-right:5px;dispaly:flex;"><h3 style="font-size: 18px;font-weight: bold; letter-spacing: 0.8px; padding-left:5pz;background-color:#3731B0; color:#fff" >Connections </h3></div><div>
        <button type="button" class="btn btn-info pull-right" data-toggle="collapse" data-target="#demo" style="width:inherit;">View Report</button></div></div-->
       <div class="container-fluid connection-data" style='padding-top:5px; display: flex; '><div style="width:90%; padding-right:5px;"><h3 style="font-size: 18px;font-weight: bold; letter-spacing: 0.8px; padding-left:10px; background-color:#3731B0; color:#fff" >Connections </h3></div>
        <div>
        <button type="button" class="btn btn-info pull-right" data-toggle="collapse" data-target="#demo" style="width:inherit;">View Report</button></div>
        </div>

        <div id="demo" class="collapse" style="display:flex; vertical-align:top; margin-top:22px; margin-left:30px; border:1px solid #FFF ; ">   
  {% load pagination_tags %}
  {% autopaginate bags 50 %}
  {% paginate %}



          <table class="table table-hover table-striped table-condensed table-bordered" style="display:flex;  border:2px solid #d3d3d3; padding-left:20px;padding-right:20px; align:center;width:auto;">
          <thead><tr><th>Connection ID</th><th>Origin</th><th>Coloader</th> <th>Total Bags</th><th>No.of Shipments</th><th>Pending Bags</th><th>System Weight</th><th>Date of Connection</th><th>Elapsed</th></tr></thead>
            <tbody>
            {% for conn, shpmt in conn_bags.items %}
            {% for t in totalwight.items %}
            {% for p in pending_bags.items %}

	     <tr> 
             <td>{{conn.id}}</td> 
             <td>{{conn.origin}}</td>
             <td>{{conn.coloader}}</td>
             <td>
<a href="#"  title="View bags" onClick="MM_openBrWindow('/hub/connection_bags/{{conn.id}}/','Bags','scrollbars=yes,width=400,height=300')">{{conn.bags.count}}</a> </td>
<td>
<a href="#" title="View bags" onClick="MM_openBrWindow('/hub/connection_bags/{{conn.id}}/','Bags','scrollbars=yes,width=400,height=300')">{{shpmt}}</a> </td>
            <td><a href="#"  title="View bags" onClick="MM_openBrWindow('/hub/connection_bags/{{conn.id}}/','Bags','scrollbars=yes,width=400,height=300')">{{ p }}</a></td>
            <td>
            <a href="#"  title="View bags" onClick="MM_openBrWindow('/hub/connection_bags/{{conn.id}}/','Bags','scrollbars=yes,width=400,height=300')">{{ t }}</a> </td>
              <td> {{ conn.added_on }} </td>

            </tr>
            {% endfor %}{% endfor %}
	    {% endfor %}
            </tbody>
            </table>
            </div>
            </div>
<div style="display:inline-block; vertical-align:top; margin-top:22px; margin-left:30px;border:1px solid #999 ; ">
            	<h3 style="font-size: 18px;font-weight: bold; letter-spacing: 0.8px; padding: 0 0 0 10px; background-color:#3731B0; color:#fff">Bag Report </h3>
              <table class="table tableexpscanned">
              <thead>
                <tr>
                  <th>scanned Bag No.</th>
<th>Shipments</th>                
  <th>Destination</th>
                  <th>Weight</th>
                  <th>Type</th>
                  <th>Status</th>
                <th>Connection ID</th>  
<th>Origin</th>
<th>Connection Date</th>
                </tr>
              </thead>
              <tbody>
             </tbody>
            </table>
 


                <table class="table tableexp">
              <thead>
                <tr>
                  <th>Bag No.</th>
<th>Shipments</th>                
  <th>Destination</th>
                  <th>Weight</th>
                  <th>Type</th>
                  <th>Status</th>
                <th>Connection ID</th>  
<th>Origin</th>
<th>Connection Date</th>
                </tr>
              </thead>
              <tbody>
            {% for b in bags%}
              	<tr>
              	
                    <td>{{b.bag_number}}</td>
		    <td>{{b.shipments.count}}</td>
                    <td>{{b.destination}}</td>
                    <td>{{b.actual_weight}}</td>
                    <td>{{b.bag_type}}</td>
                    <td> 
                  {% ifequal b.status_type 1%}  
                  <span class="label label-success">Inscanned</span>
                  {%endifequal%}
                  {% ifequal b.status_type 2%}  
                  <span class="label label-red">Short</span>
                  {%endifequal%}
                  {% ifequal b.status_type 3%}  
                  <span class="label label-black">Extra</span>
                  {%endifequal%}
                  

                    </td>
               <td>{% for c in b.connection_set.all%}
{%if forloop.last%}
{{c.id}}
{%endif%}
{%endfor%}
</td>
<td>{{b.origin}}</td>
<td>{{b.updated_on}}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
            </div>


            {%comment%}
            <div style="display:inline-block; width:300px; vertical-align:top; margin-top:22px; margin-left:30px">
            	<h3>Bag Exception Report </h3>
                <table class="table tableexp">
              <thead>
	                <tr>
                  <th>Bag No.</th>
                  <th>Origin</th>
                  <th>Weight</th>
                  
                  
                </tr>
              </thead>
              <tbody>
            {% for b in mismatch_bags%}
              	<tr>
              	
                	<td>{{b.bag_number}}</td>
                    <td>{{b.destination}}</td>
                    <td>{{b.actual_weight}}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
            </div>
            <div style="display:inline-block; width:300px; vertical-align:top; margin-top:22px; margin-left:50px">
            	<h3>Destination Bag </h3>
                <table class="table tablesuc">
              <thead>
                <tr>
                  <th>Bag No.</th>
                  <th>No. Of Shipment</th>
                  
                  
                  
                </tr>
              </thead>
              <tbody>
              {% for a in sucess_bags%}
              	<tr>
                	<td>{{a.bag_number}}</td>
                    <td>{{a.shipments.count}}</td>
                    
                </tr>
                {%endfor%}
              </tbody>
            </table>
            </div>
          </div>
          {%endcomment%}

 <div style="display:inline-block; vertical-align:top; margin-top:22px; margin-left:50px; border:1px solid #999 ;">
            	<h3 style="font-size: 18px;font-weight: bold; letter-spacing: 0.8px; padding: 0 0 0 10px; background-color:#3731B0; color:#fff">AWB Query </h3>
            <table class="table tablesuc">
              <thead>
                <tr>
                  <th>Awb Number</th>
                  <th>Bag Number</th>
                  
                  
                  
                </tr>
              </thead>
              <tbody>
              	<tr>
                	<td><input style=" width:100px" type="text" size="9" placeholder="Air Waybill Number" class="awb_no" id="awb_no" name="awb_no"/></td>
                    <td><input style=" width:100px" type="text" size="9" placeholder="Bag Number" class="bag_no" id="bag_no" name="bag_no"/></td>
                    
                </tr>
               
              </tbody>
            </table>
            </div>



          
    </div><!-- /row-fluid -->
    
    
  </div><!-- /container-fluid -->
             
</div>
<div style="margin-top:10px">
          
          <div class="pull-right" style="display:inline-block"><a href="#"  href="#" data-rev-action="modal" data-target="#add-revlet"> Notify</a></div>
          </div>



<!-- modal -->
  <div class="modal hide modal-add-revlet" id="add-revlet">
    <div class="modal-header">
      <a class="close" data-dismiss="modal">Ã—</a>
      <h3> Bag Exception Report </h3>
    </div>
    <div style="height:68px;" class="modal-body">
    
    <form>
        	<input type="text" Placeholder=" Email"/>
            <a href="#"><i class="icon-plus-sign"></i> </a><br>
            <input type="button" class="btn btn-success" value="Send" />
        </form>
   		
    </div>
  </div><!--modal end-->




<script>
$(function(){
$("#bag_scan").focus();

$('input:text:first').focus();
            var $inp = $('input:text');
            $inp.bind('keydown', function(e) {
                //var key = (e.keyCode ? e.keyCode : e.charCode);
                var key = e.which;
                if (key == 13) {
                    e.preventDefault();
                    var nxtIdx = $inp.index(this) + 1;
                    $(":input:text:eq(" + nxtIdx + ")").focus();
                }
            });


$(".awb_no").change(function(){
$("#bag_no").val("");
var awb=$("input.awb_no").val();
var datastring = "awb="+awb;
$.ajax({
type:"POST",
url: "/service-centre/awb_query/",
data: datastring,
success: function(resp){
$("#bag_no").val(resp);

}
})
});


$(".inscan_bag").change(function(){
    
    var bag_id=$("input.inscan_bag").val();
    var table_data = $(".tableexpscanned > tbody").html();
    var datastring = "bag_id="+bag_id;
    $.ajax({
    type:"POST",
    url: "/hub/",
    data: datastring,
    success: function(resp){
    $("input.inscan_bag").focus();
    if (resp == "Does Not Exists"){
        alert("Invalid Bag ID");
        return false;
    }
    
    data=eval('(' + resp + ')');
    
    
    $.each(data, function(key, value) {
    $("#"+ key).val(value);
    if (key == "bag_exception"){
    $(".tableexpscanned > tbody").html("")
    $(".tableexpscanned > tbody").append(value);
    $(".tableexpscanned > tbody").append(table_data);
    //var e = $("#suc_count").html()
    //var f = $("#mis_count").html()
    
    //$("#verified_count").val(e)
    //$("#mismatch_count").val(f)
    
      }
    if (key == "bag_success"){
    $(".tablesuc > tbody").append(value);
    }
    
    
    });
    
    
    
    /*
    $.each(data, function(key, value) {
    $("#"+ key).val(value);
     //   alert(key + "=" + value);
    });
    location.reload();
    }*/
    },
    error:function(resp){
    alert("Invalid Bag ID")
    }
    
});
$("#bag_scan").val("");
$("#bag_scan").focus();
     return false;


});
});



</script>

{% endblock %}
          	

